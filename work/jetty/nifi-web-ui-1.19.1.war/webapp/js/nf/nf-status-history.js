(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","d3","nf.Common","nf.Dialog","nf.ErrorHandler"],function(e,c,f,d,g){return(nf.StatusHistory=b(e,c,f,d,g))})}else{if(typeof exports==="object"&&typeof module==="object"){module.exports=(nf.StatusHistory=b(require("jquery"),require("d3"),require("nf.Common"),require("nf.Dialog"),require("nf.ErrorHandler")))}else{nf.StatusHistory=b(a.$,a.d3,a.nf.Common,a.nf.Dialog,a.nf.ErrorHandler)}}}(this,function(e,y,i,t,g){var x={nifiInstanceId:"nifi-instance-id",nifiInstanceLabel:"NiFi",type:{processor:"Processor",inputPort:"Input Port",outputPort:"Output Port",processGroup:"Process Group",remoteProcessGroup:"Remote Process Group",connection:"Connection",funnel:"Funnel",template:"Template",label:"Label",node:"Node"},urls:{api:"../nifi-api"}};var w={DURATION:function(A){return i.formatDuration(A)},COUNT:function(A){if(A%1===0){return i.formatInteger(A)}else{return i.formatFloat(A)}},DATA_SIZE:function(A){return i.formatDataSize(A)},FRACTION:function(A){return i.formatFloat(A/1000000)}};var o=null;var c=null;var r=null;var d=null;var l=function(C,G,E,B,F){e("#status-history-last-refreshed").text(E.generated);var A={groupId:C,id:G,type:B,instances:[]};var D=E.fieldDescriptors;A.details=E.componentDetails;A.selectedDescriptor=i.isUndefined(F)?D[0]:F;if(i.isDefinedAndNotNull(E.aggregateSnapshots)&&E.aggregateSnapshots.length>1){A.instances.push({id:x.nifiInstanceId,label:x.nifiInstanceLabel,snapshots:E.aggregateSnapshots})}else{k();return}e.each(E.nodeSnapshots,function(I,H){if(i.isDefinedAndNotNull(H.statusSnapshots)&&H.statusSnapshots.length>1){A.instances.push({id:H.nodeId,label:H.address+":"+H.apiPort,snapshots:H.statusSnapshots})}});if(A.instances.length>0){e("#status-history-dialog").data("status-history",A);s(A,D)}else{k()}};var h=function(C){e("#status-history-last-refreshed").text(C.generated);var A={type:"Node",instances:[]};var B=C.fieldDescriptors;A.details=C.componentDetails;A.selectedDescriptor=B[0];if(i.isDefinedAndNotNull(C.aggregateSnapshots)&&C.aggregateSnapshots.length>1){A.instances.push({id:x.nifiInstanceId,label:x.nifiInstanceLabel,snapshots:C.aggregateSnapshots})}else{k();return}e.each(C.nodeSnapshots,function(E,D){if(i.isDefinedAndNotNull(D.statusSnapshots)&&D.statusSnapshots.length>1){A.instances.push({id:D.nodeId,label:D.address+":"+D.apiPort,snapshots:D.statusSnapshots})}});if(A.instances.length>0){e("#status-history-dialog").data("status-history",A);s(A,B)}else{k()}};var k=function(){t.showOkDialog({headerText:"Status History",dialogContent:"Insufficient history, please try again later."})};var s=function(A,B){if(d===null){d={}}e.each(A.instances,function(D,C){C.snapshots.forEach(function(G){var F=new Date();var E=F.getTimezoneOffset()*60*1000;G.timestamp=new Date(G.timestamp+E+o)})});n(B,A.selectedDescriptor)};var n=function(C,B){var A=[];e.each(C,function(D,E){A.push({text:E.label,value:E.field,description:i.escapeHtml(E.description)})});e("#status-history-metric-combo").combo({selectedOption:{value:B.field},options:A,select:function(E){var F=null;e.each(C,function(G,H){if(E.value===H.field){F=H;return false}});if(F!==null){if(r===null||r.field!==F.field){c=null}r=F;var D=e("#status-history-dialog").data("status-history");D.selectedDescriptor=F;e("#status-history-dialog").data("status-history",D);m()}}});e("#status-history-dialog").modal("show")};var a=function(){return e("#status-history-chart-container").parent().outerHeight()-e("#status-history-chart-control-container").outerHeight()-parseInt(e("#status-history-chart-control-container").css("margin-top"),10)};var z=function(){return e("body").height()-e("#status-history-chart-control-container").outerHeight()-e("#status-history-refresh-container").outerHeight()-parseInt(e("#status-history-chart-control-container").css("margin-top"),10)-parseInt(e(".dialog-content").css("top"))-parseInt(e(".dialog-content").css("bottom"))};var v=function(){return e("body").width()-e("#status-history-details").innerWidth()-parseInt(e("#status-history-dialog").css("left"),10)-parseInt(e(".dialog-content").css("left"))-parseInt(e(".dialog-content").css("right"))};var m=function(){var ai=e("#status-history-dialog");if(ai.is(":visible")){var ab=ai.data("status-history");var ah=ab.selectedDescriptor;e("#status-history-details").empty();var D=p("Status History");y.map(ab.details).each(function(ax,aw){j(D,aw,ax)});var F={top:15,right:20,bottom:25,left:75};var Y=y.scaleOrdinal(y.schemeCategory10);var C=[];e.each(ab.instances,function(ax,aw){C.push(aw.label)});Y.domain(C);var at=[];e.each(ab.instances,function(ax,aw){if(i.isUndefinedOrNull(d[aw.id])){d[aw.id]=true}at.push({id:aw.id,label:aw.label,values:e.map(aw.snapshots,function(ay){return{timestamp:ay.timestamp,value:ay.statusMetrics[ah.field]}}),visible:d[aw.id]===true})});var P=function(aw){if(aw.getMilliseconds()){return y.timeFormat(":%S.%L")(aw)}else{if(aw.getSeconds()){return y.timeFormat(":%S")(aw)}else{if(aw.getMinutes()||aw.getHours()){return y.timeFormat("%H:%M")(aw)}else{if(aw.getDay()&&aw.getDate()!==1){return y.timeFormat("%a %d")(aw)}else{if(aw.getDate()!==1){return y.timeFormat("%b %d")(aw)}else{if(aw.getMonth()){return y.timeFormat("%B")(aw)}else{return y.timeFormat("%Y")(aw)}}}}}}};var O=e("#status-history-chart-container").empty();if(O.hasClass("ui-resizable")){O.resizable("destroy");O.removeAttr("style")}O.height(a());var A=O.outerWidth()-F.left-F.right;var B=O.outerHeight()-F.top-F.bottom;W=e("#status-history-container").width();if(A>W){A=W}an=z();if(B>an){B=an}var af=y.scaleTime().range([0,A]);var V=y.axisBottom(af).ticks(5).tickFormat(P);var ae=y.scaleLinear().range([B,0]);var G=y.axisLeft(ae).tickFormat(w[ah.formatter]);var H=y.line().curve(y.curveMonotoneX).x(function(aw){return af(aw.timestamp)}).y(function(aw){return ae(aw.value)});var N=y.select("#status-history-chart-container").append("svg").attr("style","pointer-events: none;").attr("width",O.parent().width()).attr("height",O.innerHeight());var I=N.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",A).attr("height",B);var av=N.append("g").attr("transform","translate("+F.left+", "+F.top+")");var E=y.min(at,function(aw){return y.min(aw.values,function(ax){return ax.timestamp})});var L=y.max(at,function(aw){return y.max(aw.values,function(ax){return ax.timestamp})});j(D,"Start",i.formatDateTime(E));j(D,"End",i.formatDateTime(L));af.domain([E,L]);ae.domain([q(at),u(at)]);av.append("g").attr("class","x axis").attr("transform","translate(0, "+B+")").call(V);av.append("g").attr("class","y axis").call(G).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").attr("text-anchor","end").text(ah.label);var ac=av.selectAll(".status").data(at).enter().append("g").attr("clip-path","url(#clip)").attr("class","status");ac.append("path").attr("class",function(aw){return"chart-line chart-line-"+aw.id}).attr("d",function(aw){return H(aw.values)}).attr("stroke",function(aw){return Y(aw.label)}).classed("hidden",function(aw){return aw.visible===false}).append("title").text(function(aw){return aw.label});ac.each(function(aw){var ax=y.select(this).append("g").attr("class",function(){return"mark-group mark-group-"+aw.id}).classed("hidden",function(ay){return ay.visible===false});ax.selectAll("circle.mark").data(aw.values).enter().append("circle").attr("style","pointer-events: all;").attr("class","mark").attr("cx",function(ay){return af(ay.timestamp)}).attr("cy",function(ay){return ae(ay.value)}).attr("fill",function(){return Y(aw.label)}).attr("r",1.5).append("title").text(function(ay){return aw.label+" -- "+w[ah.formatter](ay.value)})});N.attr("width",O.parent().width()).attr("height",O.innerHeight());I.attr("width",A).attr("height",B);av.select(".x.axis").attr("transform","translate(0, "+B+")");var U=e("#status-history-chart-control-container").empty();var S=U.innerHeight()-F.top-F.bottom;var al=y.scaleTime().range([0,A]);var K=y.axisBottom(al).ticks(5).tickFormat(P);var ap=y.scaleLinear().range([S,0]);var aj=y.axisLeft(ap).tickValues(ae.domain()).tickFormat(w[ah.formatter]);var R=y.line().curve(y.curveMonotoneX).x(function(aw){return al(aw.timestamp)}).y(function(aw){return ap(aw.value)});var ag=y.select("#status-history-chart-control-container").append("svg").attr("width",O.parent().width()).attr("height",S+F.top+F.bottom);var X=ag.append("g").attr("transform","translate("+F.left+", "+F.top+")");al.domain(af.domain());ap.domain(ae.domain());X.append("g").attr("class","x axis").attr("transform","translate(0, "+S+")").call(K);X.append("g").attr("class","y axis").call(aj);var au=X.selectAll(".status").data(at).enter().append("g").attr("class","status");au.append("path").attr("class",function(aw){return"chart-line chart-line-"+aw.id}).attr("d",function(aw){return R(aw.values)}).attr("stroke",function(aw){return Y(aw.label)}).classed("hidden",function(aw){return d[aw.id]===false}).append("title").text(function(aw){return aw.label});var M=function(){var aB=e.map(at,function(aH){var aF=af.domain();var aG=ae.domain();var aI=e.extend({},aH);return e.extend(aI,{values:e.grep(aH.values,function(aJ){return aJ.timestamp.getTime()>=aF[0].getTime()&&aJ.timestamp.getTime()<=aF[1].getTime()&&aJ.value>=aG[0]&&aJ.value<=aG[1]})})});var aw=e.grep(aB,function(aF){return aF.id!==x.nifiInstanceId&&aF.visible&&aF.values.length>0});var aA=aw.length===0?"NA":w[ah.formatter](q(aw));var az=aw.length===0?"NA":w[ah.formatter](f(aw));var ax=aw.length===0?"NA":w[ah.formatter](u(aw));e("#node-aggregate-statistics").text(aA+" / "+ax+" / "+az);var aD=e.grep(aB,function(aF){return aF.id===x.nifiInstanceId&&aF.visible&&aF.values.length>0});var aE=aD.length===0?"NA":w[ah.formatter](q(aD));var aC=aD.length===0?"NA":w[ah.formatter](f(aD));var ay=aD.length===0?"NA":w[ah.formatter](u(aD));e("#cluster-aggregate-statistics").text(aE+" / "+ay+" / "+aC)};var ar=function(aw,ax){af.domain(aw);ae.domain(ax);ac.selectAll(".chart-line").attr("d",function(ay){return H(ay.values)});ac.selectAll("circle.mark").attr("cx",function(ay){return af(ay.timestamp)}).attr("cy",function(ay){return ae(ay.value)}).attr("r",function(){return y.brushSelection(Q.node())===null?1.5:4});av.select(".x.axis").call(V);av.select(".y.axis").call(G)};var J=function(){c=y.brushSelection(Q.node());var ax,aw;if(c===null){var ay=e.grep(at,function(az){return az.visible});if(ay.length===0){aw=ap.domain()}else{aw=[y.min(ay,function(az){return y.min(az.values,function(aA){return aA.value})}),y.max(ay,function(az){return y.max(az.values,function(aA){return aA.value})})]}ax=al.domain()}else{ax=[c[0][0],c[1][0]].map(al.invert,al);aw=[c[1][1],c[0][1]].map(ap.invert,ap)}ar(ax,aw);M()};var am=y.brush().extent([[al.range()[0],ap.range()[1]],[al.range()[1],ap.range()[0]]]).on("brush",J);var Q=X.append("g").attr("class","brush").on("click",J).call(am);if(i.isDefinedAndNotNull(c)){am=am.move(Q,c)}X.select("rect.selection").attr("style","pointer-events: all;").on("dblclick",function(){if(c!==null){var aw=ap.range();am.move(Q,[[c[0][0],aw[1]],[c[1][0],aw[0]]])}});var ad=e.grep(at,function(aw){return aw.id!==x.nifiInstanceId}).sort(function(ax,aw){return ax.label<aw.label?-1:ax.label>aw.label?1:0});var aq=function(ax,aw){var az=e("<div></div>").addClass("legend-label nf-checkbox-label").css("color",Y(aw.label)).text(aw.label).ellipsis();var ay=e('<div class="nf-checkbox"></div>').on("click",function(){var aA=y.selectAll("path.chart-line-"+aw.id);var aC=y.select("g.mark-group-"+aw.id);var aB=aC.classed("hidden");aA.classed("hidden",function(){return !aB});aC.classed("hidden",function(){return !aB});aw.visible=aB;d[aw.id]=aw.visible;J()}).addClass(aw.visible?"checkbox-checked":"checkbox-unchecked");e('<div class="legend-entry"></div>').append(ay).append(az).on("mouseenter",function(){y.selectAll("path.chart-line-"+aw.id).classed("over",true)}).on("mouseleave",function(){y.selectAll("path.chart-line-"+aw.id).classed("over",false)}).appendTo(ax)};var aa=e.grep(at,function(aw){return aw.id===x.nifiInstanceId});var ak=p("NiFi");j(ak,"Min / Max / Mean","","cluster-aggregate-statistics");aq(ak,aa[0]);if(ad.length>0){var Z=p("Nodes");j(Z,"Min / Max / Mean","","node-aggregate-statistics");e.each(ad,function(ax,aw){aq(Z,aw)})}J();var W,an,T,ao;O.append('<div class="ui-resizable-handle ui-resizable-se"></div>').resizable({minWidth:425,minHeight:150,handles:{se:".ui-resizable-se"},resize:function(ay,ax){ao=e("#status-history-dialog");var aw={};if(i.isDefinedAndNotNull(ao.data("nf-dialog"))){aw=ao.data("nf-dialog")}aw["min-width"]=(ao.width()/e(window).width())*100+"%";aw["min-height"]=(ao.height()/e(window).height())*100+"%";aw.responsive["fullscreen-width"]=ao.outerWidth()+"px";aw.responsive["fullscreen-height"]=ao.outerHeight()+"px";W=v();if(ax.helper.width()>W){ax.helper.width(W);aw.responsive["fullscreen-width"]=e(window).width()+"px";aw["min-width"]="100%"}an=z();if(ax.helper.height()>an){ax.helper.height(an);aw.responsive["fullscreen-height"]=e(window).height()+"px";aw["min-height"]="100%"}T=a();if(ax.helper.height()<T){ax.helper.height(T)}aw["min-width"]=(parseInt(aw["min-width"],10)>=100)?"100%":aw["min-width"];aw["min-height"]=(parseInt(aw["min-height"],10)>=100)?"100%":aw["min-height"];ao.data("nfDialog",aw);ao.css("min-width",(O.outerWidth()+e("#status-history-details").outerWidth()+40));ao.css("min-height",(O.outerHeight()+e("#status-history-refresh-container").outerHeight()+e("#status-history-chart-control-container").outerHeight()+e(".dialog-buttons").outerHeight()+e(".dialog-header").outerHeight()+40+5));ao.center()},stop:m})}};var q=function(A){return y.min(A,function(B){return y.min(B.values,function(C){return C.value})})};var u=function(A){return y.max(A,function(B){return y.max(B.values,function(C){return C.value})})};var f=function(B){var C=0;var A=y.sum(B,function(D){C+=D.values.length;return y.sum(D.values,function(E){return E.value})});return A/C};var p=function(B){var A=e('<div class="status-history-detail"></div>').appendTo("#status-history-details");e('<div class="detail-container-label"></div>').text(B).appendTo(A);return e("<div></div>").appendTo(A)};var j=function(B,D,E,F){var C=e('<div class="detail-item"></div>').appendTo(B);e('<div class="setting-name"></div>').text(D).appendTo(C);var A=e('<div class="setting-field"></div>').text(E).appendTo(C);if(i.isDefinedAndNotNull(F)){A.attr("id",F)}};var b={init:function(A){o=A;e("#status-history-refresh-button").click(function(){var B=e("#status-history-dialog").data("status-history");if(B!==null){if(B.type===x.type.processor){b.showProcessorChart(B.groupId,B.id,B.selectedDescriptor)}else{if(B.type===x.type.processGroup){b.showProcessGroupChart(B.groupId,B.id,B.selectedDescriptor)}else{if(B.type===x.type.remoteProcessGroup){b.showRemoteProcessGroupChart(B.groupId,B.id,B.selectedDescriptor)}else{if(B.type===x.type.node){b.showNodeChart()}else{b.showConnectionChart(B.groupId,B.id,B.selectedDescriptor)}}}}}});e("#status-history-dialog").modal({scrollableContentStyle:"scrollable",headerText:"Status History",buttons:[{buttonText:"Close",color:{base:"#728E9B",hover:"#004849",text:"#ffffff"},handler:{click:function(){this.modal("hide")}}}],handler:{close:function(){e("#status-history-dialog").removeData("status-history");e("#status-history-chart-container").empty();e("#status-history-chart-control-container").empty();e("#status-history-details").empty();c=null;r=null;d=null},open:m}});e(window).on("resize",function(B){if(B.target===window){m()}i.toggleScrollable(e("#status-history-details").get(0))})},showConnectionChart:function(A,B,C){e.ajax({type:"GET",url:x.urls.api+"/flow/connections/"+encodeURIComponent(B)+"/status/history",dataType:"json"}).done(function(D){l(A,B,D.statusHistory,x.type.connection,C)}).fail(g.handleAjaxError)},showProcessorChart:function(A,C,B){e.ajax({type:"GET",url:x.urls.api+"/flow/processors/"+encodeURIComponent(C)+"/status/history",dataType:"json"}).done(function(D){l(A,C,D.statusHistory,x.type.processor,B)}).fail(g.handleAjaxError)},showNodeChart:function(){e.ajax({type:"GET",url:x.urls.api+"/controller/status/history",dataType:"json"}).done(function(A){h(A.statusHistory)}).fail(g.handleAjaxError)},showProcessGroupChart:function(B,A,C){e.ajax({type:"GET",url:x.urls.api+"/flow/process-groups/"+encodeURIComponent(A)+"/status/history",dataType:"json"}).done(function(D){l(B,A,D.statusHistory,x.type.processGroup,C)}).fail(g.handleAjaxError)},showRemoteProcessGroupChart:function(B,A,C){e.ajax({type:"GET",url:x.urls.api+"/flow/remote-process-groups/"+encodeURIComponent(A)+"/status/history",dataType:"json"}).done(function(D){l(B,A,D.statusHistory,x.type.remoteProcessGroup,C)}).fail(g.handleAjaxError)}};return b}));